<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Test Agents Supabase</title>
    <script src="https://unpkg.com/@supabase/supabase-js@2"></script>
    <style>
        body { font-family: Arial, sans-serif; margin: 20px; background: #1a1a1a; color: white; }
        .container { max-width: 1000px; margin: 0 auto; }
        .test-section { background: #2a2a2a; padding: 20px; margin: 20px 0; border-radius: 10px; }
        .success { color: #4ade80; }
        .error { color: #f87171; }
        button { padding: 10px 20px; margin: 10px; background: #3b82f6; color: white; border: none; border-radius: 5px; cursor: pointer; }
        button:hover { background: #2563eb; }
        pre { background: #1a1a1a; padding: 15px; border-radius: 5px; overflow-x: auto; white-space: pre-wrap; }
        input, textarea { padding: 10px; margin: 5px; background: #3a3a3a; color: white; border: 1px solid #555; border-radius: 5px; width: 200px; }
        .form-group { margin: 10px 0; }
        label { display: block; margin-bottom: 5px; font-weight: bold; }
    </style>
</head>
<body>
    <div class="container">
        <h1>üîß Test des Agents dans Supabase</h1>
        
        <div class="test-section">
            <h2>1. Configuration</h2>
            <div id="config-status">V√©rification...</div>
        </div>

        <div class="test-section">
            <h2>2. V√©rifier la table agents</h2>
            <button onclick="checkAgentsTable()">V√©rifier la table</button>
            <div id="table-result"></div>
        </div>

        <div class="test-section">
            <h2>3. Cr√©er la table agents si n√©cessaire</h2>
            <button onclick="createAgentsTable()">Cr√©er la table</button>
            <div id="create-result"></div>
        </div>

        <div class="test-section">
            <h2>4. Lister les agents existants</h2>
            <button onclick="listAgents()">Voir tous les agents</button>
            <div id="agents-list"></div>
        </div>

        <div class="test-section">
            <h2>5. Tester l'ajout d'un agent</h2>
            <div class="form-group">
                <label>Nom:</label>
                <input type="text" id="agent-name" value="Agent Test" placeholder="Nom de l'agent">
            </div>
            <div class="form-group">
                <label>Identifiant:</label>
                <input type="text" id="agent-identifier" value="+33123456789" placeholder="Num√©ro WhatsApp">
            </div>
            <div class="form-group">
                <label>Plateforme:</label>
                <select id="agent-platform" style="padding: 10px; background: #3a3a3a; color: white; border: 1px solid #555; border-radius: 5px;">
                    <option value="whatsapp">WhatsApp</option>
                    <option value="wechat">WeChat</option>
                    <option value="telegram">Telegram</option>
                </select>
            </div>
            <div class="form-group">
                <label>Cat√©gorie:</label>
                <select id="agent-category" style="padding: 10px; background: #3a3a3a; color: white; border: 1px solid #555; border-radius: 5px;">
                    <option value="electronics">√âlectronique</option>
                    <option value="fashion">Mode</option>
                    <option value="health">Sant√©</option>
                    <option value="automotive">Automobile</option>
                    <option value="home">Maison</option>
                    <option value="services">Services</option>
                    <option value="other">Autre</option>
                </select>
            </div>
            <button onclick="testAddAgent()">Tester ajout agent</button>
            <div id="add-result"></div>
        </div>

        <div class="test-section">
            <h2>6. Supprimer l'agent de test</h2>
            <button onclick="deleteTestAgent()">Supprimer agent test</button>
            <div id="delete-result"></div>
        </div>
    </div>

    <script>
        // Configuration Supabase
        const supabaseUrl = 'https://qoynvpciuxhipessvojj.supabase.co';
        const supabaseKey = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InFveW52cGNpdXhoaXBlc3N2b2pqIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTI5OTgzMjgsImV4cCI6MjA2ODU3NDMyOH0.md1_Pxl8YyUTOxdTzhCNgfiIrQkH-WYTIg7XfblL_z8';
        
        const supabase = window.supabase.createClient(supabaseUrl, supabaseKey);
        let testAgentId = null;

        // V√©rifier la configuration au chargement
        document.addEventListener('DOMContentLoaded', () => {
            const configDiv = document.getElementById('config-status');
            configDiv.innerHTML = `
                <div class="success">‚úÖ URL: ${supabaseUrl}</div>
                <div class="success">‚úÖ Cl√©: ${supabaseKey.substring(0, 20)}...</div>
            `;
        });

        async function checkAgentsTable() {
            const resultDiv = document.getElementById('table-result');
            resultDiv.innerHTML = '<div>‚è≥ V√©rification de la table agents...</div>';
            
            try {
                const { data, error } = await supabase
                    .from('agents')
                    .select('count', { count: 'exact', head: true });
                
                if (error) {
                    resultDiv.innerHTML = `<div class="error">‚ùå Table 'agents' n'existe pas: ${error.message}</div>
                                          <p>‚ö†Ô∏è Il faut cr√©er la table agents dans Supabase</p>`;
                } else {
                    resultDiv.innerHTML = `<div class="success">‚úÖ Table 'agents' existe!</div>`;
                }
            } catch (err) {
                resultDiv.innerHTML = `<div class="error">‚ùå Erreur: ${err.message}</div>`;
            }
        }

        async function createAgentsTable() {
            const resultDiv = document.getElementById('create-result');
            resultDiv.innerHTML = '<div>‚è≥ Cr√©ation de la table agents...</div>';
            
            const createTableSQL = \`
                -- Cr√©ation de la table agents
                CREATE TABLE IF NOT EXISTS public.agents (
                    id UUID DEFAULT gen_random_uuid() PRIMARY KEY,
                    name TEXT NOT NULL,
                    identifier TEXT NOT NULL,
                    email TEXT,
                    phone_number TEXT,
                    platform TEXT NOT NULL DEFAULT 'whatsapp',
                    category TEXT NOT NULL DEFAULT 'other',
                    specialties TEXT[],
                    status TEXT NOT NULL DEFAULT 'active' CHECK (status IN ('active', 'inactive', 'suspended', 'pending')),
                    description TEXT,
                    admin_notes TEXT,
                    location TEXT,
                    languages TEXT[] DEFAULT ARRAY['Fran√ßais']::TEXT[],
                    rating DECIMAL(3,2) DEFAULT 0.00 CHECK (rating >= 0 AND rating <= 5),
                    total_reviews INTEGER DEFAULT 0,
                    verification_date TIMESTAMP WITH TIME ZONE,
                    created_at TIMESTAMP WITH TIME ZONE DEFAULT NOW(),
                    updated_at TIMESTAMP WITH TIME ZONE DEFAULT NOW()
                );

                -- Index pour optimiser les recherches
                CREATE INDEX IF NOT EXISTS idx_agents_platform ON public.agents(platform);
                CREATE INDEX IF NOT EXISTS idx_agents_category ON public.agents(category);
                CREATE INDEX IF NOT EXISTS idx_agents_status ON public.agents(status);
                CREATE INDEX IF NOT EXISTS idx_agents_name ON public.agents(name);

                -- RLS
                ALTER TABLE public.agents ENABLE ROW LEVEL SECURITY;

                -- Politique d'acc√®s
                CREATE POLICY "Allow all operations on agents" ON public.agents
                    FOR ALL USING (true);

                -- Trigger pour updated_at
                CREATE OR REPLACE FUNCTION update_updated_at_column()
                RETURNS TRIGGER AS $$
                BEGIN
                    NEW.updated_at = NOW();
                    RETURN NEW;
                END;
                $$ language 'plpgsql';

                CREATE TRIGGER update_agents_updated_at BEFORE UPDATE
                    ON public.agents FOR EACH ROW EXECUTE PROCEDURE update_updated_at_column();
            \`;
            
            resultDiv.innerHTML = \`<div class="error">‚ö†Ô∏è Impossible de cr√©er via JavaScript. Copie ce SQL dans l'√©diteur Supabase:</div>
                                  <pre>\${createTableSQL}</pre>\`;
        }

        async function listAgents() {
            const resultDiv = document.getElementById('agents-list');
            resultDiv.innerHTML = '<div>‚è≥ Chargement des agents...</div>';
            
            try {
                const { data, error } = await supabase
                    .from('agents')
                    .select('*')
                    .order('created_at', { ascending: false });
                
                if (error) {
                    resultDiv.innerHTML = \`<div class="error">‚ùå Erreur: \${error.message}</div>\`;
                } else {
                    if (data.length === 0) {
                        resultDiv.innerHTML = '<div>üì≠ Aucun agent trouv√©</div>';
                    } else {
                        let html = \`<div class="success">‚úÖ \${data.length} agent(s) trouv√©(s):</div><pre>\`;
                        data.forEach((agent, index) => {
                            html += \`\${index + 1}. \${agent.name} (\${agent.platform}) - \${agent.category}\\n\`;
                        });
                        html += '</pre>';
                        resultDiv.innerHTML = html;
                    }
                }
            } catch (err) {
                resultDiv.innerHTML = \`<div class="error">‚ùå Erreur: \${err.message}</div>\`;
            }
        }

        async function testAddAgent() {
            const resultDiv = document.getElementById('add-result');
            const name = document.getElementById('agent-name').value;
            const identifier = document.getElementById('agent-identifier').value;
            const platform = document.getElementById('agent-platform').value;
            const category = document.getElementById('agent-category').value;
            
            if (!name || !identifier) {
                resultDiv.innerHTML = '<div class="error">‚ùå Nom et identifiant requis</div>';
                return;
            }
            
            resultDiv.innerHTML = '<div>‚è≥ Ajout de l\'agent...</div>';
            
            try {
                const { data, error } = await supabase
                    .from('agents')
                    .insert([{
                        name: name,
                        identifier: identifier,
                        platform: platform,
                        category: category,
                        status: 'active',
                        description: 'Agent de test cr√©√© via l\'interface de debug'
                    }])
                    .select()
                    .single();
                
                if (error) {
                    resultDiv.innerHTML = \`<div class="error">‚ùå Erreur ajout: \${error.message}</div>\`;
                } else {
                    testAgentId = data.id;
                    resultDiv.innerHTML = \`<div class="success">‚úÖ Agent ajout√© avec succ√®s!</div>
                                          <pre>ID: \${data.id}\\nNom: \${data.name}\\nPlateforme: \${data.platform}</pre>\`;
                }
            } catch (err) {
                resultDiv.innerHTML = \`<div class="error">‚ùå Erreur: \${err.message}</div>\`;
            }
        }

        async function deleteTestAgent() {
            const resultDiv = document.getElementById('delete-result');
            
            if (!testAgentId) {
                resultDiv.innerHTML = '<div class="error">‚ùå Aucun agent de test √† supprimer</div>';
                return;
            }
            
            resultDiv.innerHTML = '<div>‚è≥ Suppression de l\'agent de test...</div>';
            
            try {
                const { error } = await supabase
                    .from('agents')
                    .delete()
                    .eq('id', testAgentId);
                
                if (error) {
                    resultDiv.innerHTML = \`<div class="error">‚ùå Erreur suppression: \${error.message}</div>\`;
                } else {
                    resultDiv.innerHTML = '<div class="success">‚úÖ Agent de test supprim√©</div>';
                    testAgentId = null;
                }
            } catch (err) {
                resultDiv.innerHTML = \`<div class="error">‚ùå Erreur: \${err.message}</div>\`;
            }
        }
    </script>
</body>
</html>