<!DOCTYPE html>
<html>
<head>
    <title>🔍 Debug Direct Supabase</title>
    <style>
        body { font-family: monospace; padding: 20px; }
        .result { background: #f0f0f0; padding: 10px; margin: 10px 0; border-left: 4px solid #007acc; }
        .error { border-left-color: #dc3545; }
        .success { border-left-color: #28a745; }
        button { padding: 10px 15px; margin: 5px; cursor: pointer; }
    </style>
</head>
<body>
    <h1>🔍 Debug Direct - Exactement comme ton code</h1>
    
    <button onclick="testFullFlow()">🧪 Test Complet (comme ton code)</button>
    <button onclick="testTableAccess()">📊 Test Accès Table</button>
    <button onclick="testInsert()">➕ Test Insert Direct</button>
    <button onclick="clearResults()">🧹 Effacer</button>
    
    <div id="results"></div>

    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <script>
        // EXACTEMENT tes clés
        const supabaseUrl = 'https://qoynvpciuxhipessvojj.supabase.co';
        const supabaseKey = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InFveW52cGNpdXhoaXBlc3N2b2pqIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTI5OTgzMjgsImV4cCI6MjA2ODU3NDMyOH0.md1_Pxl8YyUTOxdTzhCNgfiIrQkH-WYTIg7XfblL_z8';
        
        const supabase = window.supabase.createClient(supabaseUrl, supabaseKey);
        
        function log(message, type = 'info') {
            const div = document.createElement('div');
            div.className = `result ${type}`;
            div.innerHTML = new Date().toLocaleTimeString() + ' - ' + message;
            document.getElementById('results').appendChild(div);
            console.log(message);
        }
        
        function clearResults() {
            document.getElementById('results').innerHTML = '';
        }
        
        async function testTableAccess() {
            log('📊 Test accès table agents...', 'info');
            
            try {
                const { data, error, count } = await supabase
                    .from('agents')
                    .select('*', { count: 'exact' })
                    .limit(5);
                
                if (error) {
                    log('❌ ERREUR accès table: ' + error.message + ' (Code: ' + error.code + ')', 'error');
                    log('🔍 Détails: ' + JSON.stringify(error, null, 2), 'error');
                    return false;
                }
                
                log('✅ Table accessible - ' + (count || 0) + ' agents trouvés', 'success');
                if (data && data.length > 0) {
                    log('📋 Colonnes: ' + Object.keys(data[0]).join(', '), 'info');
                }
                return true;
                
            } catch (err) {
                log('💥 Exception: ' + err.message, 'error');
                return false;
            }
        }
        
        async function testInsert() {
            log('➕ Test insertion directe...', 'info');
            
            const testAgent = {
                name: 'Test Debug Direct',
                identifier: 'debug_' + Date.now(),
                phone_number: '+33123456789',
                email: 'test@debug.com',
                website_url: 'https://debug.com',
                platform: 'whatsapp',
                category: 'other',
                status: 'active',
                description: 'Agent de debug',
                about_description: 'Test debug',
                internal_notes: 'Notes debug',
                full_name: 'Agent Debug Complet'
            };
            
            log('📤 Données à insérer: ' + JSON.stringify(testAgent, null, 2), 'info');
            
            try {
                const { data, error } = await supabase
                    .from('agents')
                    .insert([testAgent])
                    .select()
                    .single();
                
                if (error) {
                    log('❌ ERREUR insertion: ' + error.message, 'error');
                    log('🔍 Code erreur: ' + error.code, 'error');
                    log('🔍 Détails: ' + JSON.stringify(error, null, 2), 'error');
                    return false;
                }
                
                log('✅ Agent créé avec succès! ID: ' + data.id, 'success');
                log('📄 Données créées: ' + JSON.stringify(data, null, 2), 'success');
                
                // Nettoyer
                await supabase.from('agents').delete().eq('id', data.id);
                log('🧹 Agent test supprimé', 'info');
                
                return true;
                
            } catch (err) {
                log('💥 Exception insertion: ' + err.message, 'error');
                return false;
            }
        }
        
        async function testFullFlow() {
            log('🚀 === TEST COMPLET COMME TON CODE ===', 'info');
            
            // 1. Test connexion
            log('1️⃣ Test connexion Supabase...', 'info');
            try {
                const { error } = await supabase.from('agents').select('count', { count: 'exact', head: true });
                if (error) {
                    log('❌ Connexion échouée: ' + error.message, 'error');
                    return;
                }
                log('✅ Connexion OK', 'success');
            } catch (err) {
                log('💥 Connexion impossible: ' + err.message, 'error');
                return;
            }
            
            // 2. Test accès table
            log('2️⃣ Test accès table...', 'info');
            const tableOK = await testTableAccess();
            if (!tableOK) {
                log('❌ Impossible d\'accéder à la table agents', 'error');
                return;
            }
            
            // 3. Test insertion
            log('3️⃣ Test insertion...', 'info');
            const insertOK = await testInsert();
            if (!insertOK) {
                log('❌ Insertion échouée', 'error');
                return;
            }
            
            log('🎉 === TEST COMPLET RÉUSSI ===', 'success');
            log('✅ Si ce test marche mais ton site non, le problème est dans ton code React!', 'success');
        }
        
        // Auto-test au chargement
        window.onload = function() {
            log('🚀 Page chargée - Prêt pour les tests', 'info');
        };
    </script>
</body>
</html>